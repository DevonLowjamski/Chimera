#!/bin/bash

# Project Chimera Quality Gate Pre-Commit Hook
# Prevents commits with anti-patterns defined in Phase 0.5

echo "üîí Running Project Chimera quality gate checks..."

# Get list of staged C# files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "\.cs$" | grep "Assets/ProjectChimera" || true)

if [ -z "$STAGED_FILES" ]; then
    echo "‚úÖ No C# files to check"
    exit 0
fi

# Check each staged file for violations
VIOLATIONS_FOUND=false

echo "üìÅ Checking staged files:"
for file in $STAGED_FILES; do
    echo "   - $file"
done
echo ""

# Check for FindObjectOfType
echo "üîç Checking for FindObjectOfType violations..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        VIOLATIONS=$(grep -n "FindObjectOfType" "$file" || true)
        if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå FindObjectOfType found in $file:"
            echo "$VIOLATIONS"
            echo ""
            VIOLATIONS_FOUND=true
        fi
    fi
done

# Check for Resources.Load
echo "üîç Checking for Resources.Load violations..."
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        VIOLATIONS=$(grep -n "Resources\.Load" "$file" || true)
        if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå Resources.Load found in $file:"
            echo "$VIOLATIONS"
            echo ""
            VIOLATIONS_FOUND=true
        fi
    fi
done

# Check for raw Debug.Log (exclude Systems/Diagnostics)
echo "üîç Checking for raw Debug.Log violations..."
for file in $STAGED_FILES; do
    if [ -f "$file" ] && [[ "$file" != *"Systems/Diagnostics"* ]] && [[ "$file" != *"ChimeraLogger"* ]]; then
        VIOLATIONS=$(grep -n "Debug\.Log" "$file" || true)
        if [ ! -z "$VIOLATIONS" ]; then
            echo "‚ùå Raw Debug.Log found in $file:"
            echo "$VIOLATIONS"
            echo ""
            VIOLATIONS_FOUND=true
        fi
    fi
done

# Report results
if [ "$VIOLATIONS_FOUND" = true ]; then
    echo ""
    echo "üí• Commit blocked by quality gate violations!"
    echo ""
    echo "üìã Fix these issues:"
    echo "  ‚Ä¢ Replace FindObjectOfType with ServiceContainer.Resolve<T>()"
    echo "  ‚Ä¢ Replace Resources.Load with Addressables or direct references"
    echo "  ‚Ä¢ Replace Debug.Log with ChimeraLogger.Log()"
    echo ""
    echo "Then retry your commit."
    exit 1
else
    echo "‚úÖ All quality gate checks passed!"
    echo "üöÄ Commit approved"
    exit 0
fi