using UnityEngine;
using System.Collections.Generic;
using ProjectChimera.Core.Logging;

namespace ProjectChimera.Systems.Construction.Payment
{
    /// <summary>
    /// BASIC: Simple refund handler for Project Chimera's construction payment system.
    /// Focuses on essential refund operations without complex reservation systems.
    /// </summary>
    public class RefundHandler : MonoBehaviour
    {
        [Header("Basic Refund Settings")]
        [SerializeField] private bool _enableBasicRefunds = true;
        [SerializeField] private bool _enableLogging = true;
        [SerializeField] private float _refundPercentage = 0.8f; // 80% refund
        [SerializeField] private float _maxRefundTimeHours = 24f; // 24 hours to refund

        // Basic refund tracking
        private readonly Dictionary<string, RefundRecord> _pendingRefunds = new Dictionary<string, RefundRecord>();
        private float _totalRefunded = 0f;
        private bool _isInitialized = false;

        /// <summary>
        /// Events for refund operations
        /// </summary>
        public event System.Action<string, float> OnRefundProcessed;
        public event System.Action<string> OnRefundExpired;

        /// <summary>
        /// Initialize basic refund handler
        /// </summary>
        public void Initialize()
        {
            if (_isInitialized) return;

            _isInitialized = true;

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Process a refund request
        /// </summary>
        public bool ProcessRefund(string transactionId, float originalAmount, System.DateTime transactionTime)
        {
            if (!_enableBasicRefunds || !_isInitialized) return false;

            // Check if within refund window
            float hoursSinceTransaction = (float)(System.DateTime.Now - transactionTime).TotalHours;
            if (hoursSinceTransaction > _maxRefundTimeHours)
            {
                if (_enableLogging)
                {
                    UnityEngine.Debug.Log("Operation completed");
                }
                OnRefundExpired?.Invoke(transactionId);
                return false;
            }

            // Calculate refund amount
            float refundAmount = originalAmount * _refundPercentage;

            // Record the refund
            var refundRecord = new RefundRecord
            {
                TransactionId = transactionId,
                OriginalAmount = originalAmount,
                RefundAmount = refundAmount,
                TransactionTime = transactionTime,
                RefundTime = System.DateTime.Now,
                Processed = true
            };

            _pendingRefunds[transactionId] = refundRecord;
            _totalRefunded += refundAmount;

            OnRefundProcessed?.Invoke(transactionId, refundAmount);

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }

            return true;
        }

        /// <summary>
        /// Check if transaction can be refunded
        /// </summary>
        public bool CanRefund(string transactionId, System.DateTime transactionTime)
        {
            if (!_enableBasicRefunds || !_isInitialized) return false;

            // Check if already refunded
            if (_pendingRefunds.ContainsKey(transactionId))
            {
                return false;
            }

            // Check time window
            float hoursSinceTransaction = (float)(System.DateTime.Now - transactionTime).TotalHours;
            return hoursSinceTransaction <= _maxRefundTimeHours;
        }

        /// <summary>
        /// Get refund amount for transaction
        /// </summary>
        public float GetRefundAmount(float originalAmount)
        {
            return originalAmount * _refundPercentage;
        }

        /// <summary>
        /// Get refund record
        /// </summary>
        public RefundRecord GetRefundRecord(string transactionId)
        {
            return _pendingRefunds.TryGetValue(transactionId, out var record) ? record : null;
        }

        /// <summary>
        /// Get all refund records
        /// </summary>
        public List<RefundRecord> GetAllRefundRecords()
        {
            return new List<RefundRecord>(_pendingRefunds.Values);
        }

        /// <summary>
        /// Get refund statistics
        /// </summary>
        public RefundStats GetStats()
        {
            int totalRefunds = _pendingRefunds.Count;
            float averageRefundAmount = totalRefunds > 0 ? _totalRefunded / totalRefunds : 0f;

            return new RefundStats
            {
                TotalRefundsProcessed = totalRefunds,
                TotalAmountRefunded = _totalRefunded,
                AverageRefundAmount = averageRefundAmount,
                RefundPercentage = _refundPercentage,
                MaxRefundTimeHours = _maxRefundTimeHours,
                IsRefundsEnabled = _enableBasicRefunds,
                IsInitialized = _isInitialized
            };
        }

        /// <summary>
        /// Clear old refund records (older than retention period)
        /// </summary>
        public void ClearOldRecords(float retentionDays = 30f)
        {
            var cutoffTime = System.DateTime.Now.AddDays(-retentionDays);
            var keysToRemove = new List<string>();

            foreach (var kvp in _pendingRefunds)
            {
                if (kvp.Value.RefundTime < cutoffTime)
                {
                    keysToRemove.Add(kvp.Key);
                }
            }

            foreach (string key in keysToRemove)
            {
                _pendingRefunds.Remove(key);
            }

            if (_enableLogging && keysToRemove.Count > 0)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Set refund settings
        /// </summary>
        public void SetRefundSettings(float refundPercentage, float maxRefundTimeHours)
        {
            _refundPercentage = Mathf.Clamp01(refundPercentage);
            _maxRefundTimeHours = Mathf.Max(0f, maxRefundTimeHours);

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Reset refund handler
        /// </summary>
        public void Reset()
        {
            _pendingRefunds.Clear();
            _totalRefunded = 0f;

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }
    }

    /// <summary>
    /// Refund record data
    /// </summary>
    [System.Serializable]
    public class RefundRecord
    {
        public string TransactionId;
        public float OriginalAmount;
        public float RefundAmount;
        public System.DateTime TransactionTime;
        public System.DateTime RefundTime;
        public bool Processed;
    }

    /// <summary>
    /// Refund statistics
    /// </summary>
    [System.Serializable]
    public struct RefundStats
    {
        public int TotalRefundsProcessed;
        public float TotalAmountRefunded;
        public float AverageRefundAmount;
        public float RefundPercentage;
        public float MaxRefundTimeHours;
        public bool IsRefundsEnabled;
        public bool IsInitialized;
    }
}
