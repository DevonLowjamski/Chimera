using UnityEngine;
using System;
using System.Collections.Generic;
using System.Linq;
using ProjectChimera.Data.Shared;
using QualityGrade = ProjectChimera.Data.Cultivation.Plant.HarvestQualityGrade;


namespace ProjectChimera.Data.Cultivation.Plant
{
    /// <summary>
    /// Quality Assessor - Assesses harvest quality and characteristics.
    /// Analyzes trichome development, cannabinoid profiles, terpene content,
    /// appearance, aroma, and overall quality metrics for harvested cannabis.
    /// </summary>
    public static class QualityAssessor
    {
        /// <summary>
        /// Calculates harvest quality based on plant state
        /// </summary>
        public static HarvestQuality CalculateHarvestQuality(PlantStateData plantState)
        {
            var quality = new HarvestQuality
            {
                PlantID = plantState.PlantID,
                OverallQualityScore = 0f,
                QualityGrade = "Fair",
                QualityFactors = new QualityFactors()
            };

            // Calculate individual quality components
            quality.QualityFactors.TrichomeQuality = AssessTrichomeQuality(plantState);
            quality.QualityFactors.CannabinoidProfile = AssessCannabinoidProfile(plantState);
            quality.QualityFactors.TerpeneProfile = AssessTerpeneProfile(plantState);
            quality.QualityFactors.Appearance = AssessAppearance(plantState);
            quality.QualityFactors.Aroma = AssessAroma(plantState);

            // Calculate weighted overall score
            quality.OverallQualityScore = CalculateWeightedScore(quality.QualityFactors);

            // Determine quality grade
            quality.QualityGrade = DetermineQualityGrade(quality.OverallQualityScore);

            // Generate quality description
            quality.QualityDescription = GenerateQualityDescription(quality);

            // Calculate quality metrics
            quality.QualityMetrics = CalculateQualityMetrics(plantState, quality);

            return quality;
        }

        /// <summary>
        /// Assesses trichome quality and development
        /// </summary>
        private static float AssessTrichomeQuality(PlantStateData plantState)
        {
            float trichomeQuality = plantState.MaturityLevel;

            // Trichome size and density contribute to quality
            // Simplified: use default trichome density since property doesn't exist
            float trichomeDensity = 0.8f;
            trichomeQuality *= trichomeDensity;

            // Harvest timing affects trichome quality
            if (plantState.CurrentGrowthStage == PlantGrowthStage.Ripening)
            {
                trichomeQuality *= 1.1f; // Optimal timing
            }
            else if (plantState.CurrentGrowthStage == PlantGrowthStage.Flowering)
            {
                trichomeQuality *= 0.9f; // Slightly early
            }

            // Environmental factors
            // Simplified: assume moderate humidity since Environment is a string
            float humidity = 60f; // Default humidity
            if (humidity < 40f)
            {
                trichomeQuality *= 0.95f; // Low humidity can stress trichomes
            }

            return Mathf.Clamp01(trichomeQuality);
        }

        /// <summary>
        /// Assesses cannabinoid profile quality
        /// </summary>
        private static float AssessCannabinoidProfile(PlantStateData plantState)
        {
            float cannabinoidQuality = 0.7f; // Base quality

            if (plantState.StrainSO != null)
            {
                // THC content affects quality perception
                if (plantState.THCPotential > 0)
                {
                    cannabinoidQuality = Mathf.Lerp(0.6f, 1.0f, plantState.THCPotential);
                }

                // CBD content for balanced profiles
                if (plantState.CBDPotential > 0)
                {
                    cannabinoidQuality *= 1.1f; // Balanced profiles often preferred
                }
            }

            // Harvest timing affects cannabinoid expression
            if (plantState.MaturityLevel > 0.8f)
            {
                cannabinoidQuality *= 1.05f; // Peak cannabinoid expression
            }

            // Environmental stress can affect cannabinoid production
            if (plantState.Temperature > 30f)
            {
                cannabinoidQuality *= 0.9f; // Heat stress reduces quality
            }

            return Mathf.Clamp01(cannabinoidQuality);
        }

        /// <summary>
        /// Assesses terpene profile quality
        /// </summary>
        private static float AssessTerpeneProfile(PlantStateData plantState)
        {
            float terpeneQuality = 0.6f; // Base quality

            if (!string.IsNullOrEmpty(plantState.TerpeneProfile))
            {
                // Rich terpene profiles contribute to quality
                terpeneQuality = plantState.TerpeneProfile.Length * 0.1f; // Simple length-based quality
            }

            // Environmental conditions affect terpene production
            if (plantState.Temperature >= 20f && plantState.Temperature <= 28f)
            {
                terpeneQuality *= 1.1f; // Optimal temperature for terpenes
            }

            // Light quality affects terpene production
            if (plantState.LightIntensity >= 0.7f)
            {
                terpeneQuality *= 1.05f; // Good light for terpene development
            }

            return Mathf.Clamp01(terpeneQuality);
        }

        /// <summary>
        /// Assesses visual appearance quality
        /// </summary>
        private static float AssessAppearance(PlantStateData plantState)
        {
            float appearanceQuality = 0.8f; // Base quality

            // Plant structure and symmetry
            if (!string.IsNullOrEmpty(plantState.TrainingTechniques))
            {
                appearanceQuality *= 1.1f; // Well-trained plants look better
            }

            // Color and pigmentation
            if (plantState.MaturityLevel > 0.7f)
            {
                appearanceQuality *= 1.05f; // Mature plants have better coloration
            }

            // Overall plant health affects appearance
            appearanceQuality *= plantState.OverallHealth;

            return Mathf.Clamp01(appearanceQuality);
        }

        /// <summary>
        /// Assesses aroma quality
        /// </summary>
        private static float AssessAroma(PlantStateData plantState)
        {
            float aromaQuality = 0.7f; // Base quality

            // Terpene profile directly affects aroma
            if (!string.IsNullOrEmpty(plantState.TerpeneProfile))
            {
                aromaQuality = plantState.TerpeneProfile.Length * 0.05f; // Simple intensity based on profile length
            }

            // Curing process affects aroma development
            if (plantState.MaturityLevel > 0.8f)
            {
                aromaQuality *= 1.1f; // Proper maturation enhances aroma
            }

            // Environmental conditions during growth
            if (plantState.Humidity >= 40f && plantState.Humidity <= 60f)
            {
                aromaQuality *= 1.05f; // Optimal humidity for aroma development
            }

            return Mathf.Clamp01(aromaQuality);
        }

        /// <summary>
        /// Calculates weighted overall quality score
        /// </summary>
        private static float CalculateWeightedScore(QualityFactors factors)
        {
            // Weighted calculation based on industry standards
            float weightedScore =
                (factors.TrichomeQuality * 0.3f) +      // 30% - Trichomes most important
                (factors.CannabinoidProfile * 0.25f) +   // 25% - Cannabinoids key
                (factors.TerpeneProfile * 0.2f) +        // 20% - Terpenes for aroma/flavor
                (factors.Appearance * 0.15f) +           // 15% - Visual appeal
                (factors.Aroma * 0.1f);                  // 10% - Aroma quality

            return Mathf.Clamp01(weightedScore);
        }

        /// <summary>
        /// Determines quality grade from score
        /// </summary>
        private static string DetermineQualityGrade(float score)
        {
            if (score >= 0.9f) return "Premium";
            if (score >= 0.8f) return "Excellent";
            if (score >= 0.7f) return "Good";
            if (score >= 0.6f) return "Fair";
            return "Poor";
        }

        /// <summary>
        /// Generates quality description
        /// </summary>
        private static string GenerateQualityDescription(HarvestQuality quality)
        {
            switch (quality.QualityGradeEnum)
            {
                case QualityGrade.Premium:
                    return "Exceptional quality with outstanding trichome development, balanced cannabinoid profile, and rich terpene expression. Premium market material.";
                case QualityGrade.Excellent:
                    return "High-quality harvest with well-developed trichomes, good cannabinoid content, and pleasant aroma profile.";
                case QualityGrade.Good:
                    return "Solid quality harvest with decent trichome coverage and acceptable cannabinoid/terpene profiles.";
                case QualityGrade.Fair:
                    return "Average quality harvest that meets basic standards but lacks premium characteristics.";
                case QualityGrade.Poor:
                    return "Below-standard quality with underdeveloped trichomes and weak cannabinoid/terpene profiles.";
                default:
                    return "Quality assessment incomplete";
            }
        }

        /// <summary>
        /// Calculates detailed quality metrics
        /// </summary>
        private static QualityMetrics CalculateQualityMetrics(PlantStateData plantState, HarvestQuality quality)
        {
            var metrics = new QualityMetrics();

            // Potency metrics
            metrics.EstimatedTHC = plantState.THCPotential * quality.OverallQualityScore * 25f; // Max 25%
            metrics.EstimatedCBD = plantState.CBDPotential * quality.OverallQualityScore * 20f; // Max 20%

            // Terpene content estimate
            metrics.EstimatedTerpeneContent = quality.QualityFactors.TerpeneProfile * 2.5f; // Max 2.5%

            // Market value indicators
            metrics.MarketGrade = DetermineMarketGrade(quality.QualityGradeEnum);

            // Quality consistency
            metrics.ConsistencyScore = CalculateConsistencyScore(plantState, quality);

            return metrics;
        }

        /// <summary>
        /// Determines market grade from quality grade
        /// </summary>
        private static string DetermineMarketGrade(QualityGrade qualityGrade)
        {
            switch (qualityGrade)
            {
                case QualityGrade.Premium: return "AAA Premium";
                case QualityGrade.Excellent: return "AA Grade";
                case QualityGrade.Good: return "A Grade";
                case QualityGrade.Fair: return "B Grade";
                case QualityGrade.Poor: return "C Grade";
                default: return "Ungraded";
            }
        }

        /// <summary>
        /// Calculates quality consistency score
        /// </summary>
        private static float CalculateConsistencyScore(PlantStateData plantState, HarvestQuality quality)
        {
            // Consistency based on cultivation practices and environmental stability
            float consistency = 0.8f; // Base consistency

            // Environmental stability affects consistency
            if (plantState.Temperature > 0)
            {
                if (Mathf.Abs(plantState.Temperature - 25f) < 5f)
                    consistency += 0.1f;
                if (Mathf.Abs(plantState.Humidity - 60f) < 10f)
                    consistency += 0.1f;
            }

            // Cultivation consistency
            if (plantState.IrrigationConsistency > 0.8f)
                consistency += 0.1f;
            if (plantState.NutrientConsistency > 0.8f)
                consistency += 0.1f;

            return Mathf.Clamp01(consistency);
        }

        /// <summary>
        /// Compares quality between different harvests
        /// </summary>
        public static QualityComparison CompareQuality(HarvestQuality quality1, HarvestQuality quality2)
        {
            var comparison = new QualityComparison
            {
                Quality1 = quality1,
                Quality2 = quality2,
                ScoreDifference = quality2.OverallQualityScore - quality1.OverallQualityScore,
                GradeDifference = GetQualityGradeValue(quality2.QualityGrade) - GetQualityGradeValue(quality1.QualityGrade)
            };

            // Determine improvement direction
            if (comparison.ScoreDifference > 0.1f)
            {
                comparison.ImprovementDirection = "Significant Improvement";
                comparison.ImprovementColor = Color.green;
            }
            else if (comparison.ScoreDifference > 0.05f)
            {
                comparison.ImprovementDirection = "Moderate Improvement";
                comparison.ImprovementColor = Color.green;
            }
            else if (comparison.ScoreDifference > -0.05f)
            {
                comparison.ImprovementDirection = "Stable Quality";
                comparison.ImprovementColor = Color.yellow;
            }
            else if (comparison.ScoreDifference > -0.1f)
            {
                comparison.ImprovementDirection = "Moderate Decline";
                comparison.ImprovementColor = new Color(1f, 0.5f, 0f); // Orange
            }
            else
            {
                comparison.ImprovementDirection = "Significant Decline";
                comparison.ImprovementColor = Color.red;
            }

            return comparison;
        }

        /// <summary>
        /// Convert quality grade string to numeric value for comparison
        /// </summary>
        private static int GetQualityGradeValue(string grade)
        {
            switch (grade?.ToLower())
            {
                case "excellent": return 4;
                case "good": return 3;
                case "fair": return 2;
                case "poor": return 1;
                default: return 0;
            }
        }
    }

}
