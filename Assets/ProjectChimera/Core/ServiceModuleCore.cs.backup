using UnityEngine;
using System.Collections.Generic;
using ProjectChimera.Core.Logging;
using ProjectChimera.Core.DependencyInjection;

namespace ProjectChimera.Core
{
    /// <summary>
    /// BASIC: Simple service module core for Project Chimera.
    /// Focuses on essential service management without complex providers and validation systems.
    /// </summary>
    public abstract class ServiceModuleCore : MonoBehaviour, IServiceModule
    {
        [Header("Basic Service Settings")]
        [SerializeField] private bool _enableBasicServices = true;
        [SerializeField] private bool _enableLogging = true;
        [SerializeField] private string _moduleName = "Basic Service Module";

        // IServiceModule implementation
        public virtual string ModuleName => _moduleName;
        public virtual System.Version ModuleVersion => new System.Version(1, 0, 0);
        public virtual string[] Dependencies => new string[0];

        public virtual void ConfigureServices(IServiceContainer serviceContainer)
        {
            // Basic service configuration - override in derived classes
            if (_enableLogging)
            {
                // Register basic logging if available
            }
        }

        public virtual void Initialize(IServiceContainer serviceContainer)
        {
            // Basic initialization - override in derived classes
            InitializeServiceComponents();
        }

        public virtual void Shutdown(IServiceContainer serviceContainer)
        {
            // Basic shutdown - override in derived classes
            // Cleanup resources here
        }

        public virtual bool ValidateServices(IServiceContainer serviceContainer)
        {
            // Basic validation - override in derived classes
            return _isInitialized;
        }

        // Basic service tracking
        private readonly Dictionary<string, IService> _registeredServices = new Dictionary<string, IService>();
        private bool _isInitialized = false;

        /// <summary>
        /// Events for service module
        /// </summary>
        public event System.Action<string> OnServiceRegistered;
        public event System.Action OnModuleInitialized;

        /// <summary>
        /// Initialize basic service module
        /// </summary>
        public void Initialize()
        {
            if (_isInitialized) return;

            _isInitialized = true;
            OnModuleInitialized?.Invoke();

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Register a service
        /// </summary>
        public void RegisterService(string serviceName, IService service)
        {
            if (!_enableBasicServices || !_isInitialized || service == null) return;

            _registeredServices[serviceName] = service;
            OnServiceRegistered?.Invoke(serviceName);

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Get a registered service
        /// </summary>
        public T GetService<T>(string serviceName) where T : IService
        {
            if (_registeredServices.TryGetValue(serviceName, out IService service))
            {
                try
                {
                    return (T)service;
                }
                catch
                {
                    if (_enableLogging)
                    {
                        UnityEngine.Debug.Log("Operation completed");
                    }
                    return default;
                }
            }

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
            return default;
        }

        /// <summary>
        /// Check if service is registered
        /// </summary>
        public bool IsServiceRegistered(string serviceName)
        {
            return _registeredServices.ContainsKey(serviceName);
        }

        /// <summary>
        /// Get all registered service names
        /// </summary>
        public List<string> GetRegisteredServiceNames()
        {
            return new List<string>(_registeredServices.Keys);
        }

        /// <summary>
        /// Remove a service
        /// </summary>
        public void RemoveService(string serviceName)
        {
            if (_registeredServices.Remove(serviceName))
            {
                if (_enableLogging)
                {
                    UnityEngine.Debug.Log("Operation completed");
                }
            }
        }

        /// <summary>
        /// Clear all services
        /// </summary>
        public void ClearAllServices()
        {
            var serviceNames = new List<string>(_registeredServices.Keys);
            _registeredServices.Clear();

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Set services enabled state
        /// </summary>
        public void SetServicesEnabled(bool enabled)
        {
            _enableBasicServices = enabled;

            if (!enabled)
            {
                ClearAllServices();
            }

            if (_enableLogging)
            {
                UnityEngine.Debug.Log("Operation completed");
            }
        }

        /// <summary>
        /// Get module information
        /// </summary>
        public ModuleInfo GetModuleInfo()
        {
            return new ModuleInfo
            {
                ModuleName = _moduleName,
                RegisteredServices = _registeredServices.Count,
                IsInitialized = _isInitialized,
                IsServicesEnabled = _enableBasicServices
            };
        }

        /// <summary>
        /// Get module statistics
        /// </summary>
        public ModuleStats GetStats()
        {
            return new ModuleStats
            {
                TotalServices = _registeredServices.Count,
                ActiveServices = _registeredServices.Count, // All registered services are considered active
                FailedServices = 0, // Basic implementation doesn't track failures
                ModuleUptime = _isInitialized ? Time.time : 0f
            };
        }


        /// <summary>
        /// Initialize service components (virtual for subclasses to override)
        /// </summary>
        protected virtual void InitializeServiceComponents()
        {
            // Basic implementation does nothing
        }

        /// <summary>
        /// Configure service providers (virtual for subclasses to override)
        /// </summary>
        protected virtual void ConfigureServiceProviders(IServiceContainer container)
        {
            // Basic implementation does nothing
        }

        /// <summary>
        /// Initialize service providers (virtual for subclasses to override)
        /// </summary>
        protected virtual void InitializeServiceProviders(IServiceContainer container)
        {
            // Basic implementation does nothing
        }

        /// <summary>
        /// Validate service providers (virtual for subclasses to override)
        /// </summary>
        protected virtual void ValidateServiceProviders(IServiceContainer container)
        {
            // Basic implementation does nothing
        }
    }

    // IService interface moved to ProjectChimera.Core.IService.cs for consistency

    /// <summary>
    /// Module information
    /// </summary>
    [System.Serializable]
    public struct ModuleInfo
    {
        public string ModuleName;
        public int RegisteredServices;
        public bool IsInitialized;
        public bool IsServicesEnabled;
    }

    /// <summary>
    /// Module statistics
    /// </summary>
    [System.Serializable]
    public struct ModuleStats
    {
        public int TotalServices;
        public int ActiveServices;
        public int FailedServices;
        public float ModuleUptime;
    }
}
